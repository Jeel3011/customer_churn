name: Deploy to EC2

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  REGISTRY: docker.io

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          # Create SSH key file
          mkdir -p ~/.ssh
          echo "$EC2_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          
          # Add EC2 to known_hosts
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Create deployment script
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ðŸš€ Starting deployment..."
          
          # Clean up old files
          rm -rf ~/customer_churn_temp
          mkdir -p ~/customer_churn_temp
          
          cd ~/customer_churn_temp
          
          # Clone or fetch the latest code
          if [ -d "customer_churn" ]; then
            cd customer_churn
            git pull origin main
          else
            git clone $REPO_URL .
          fi
          
          # Create environment file
          cat > .env << ENVEOF
          AWS_REGION=$AWS_REGION
          S3_BUCKET=$S3_BUCKET
          AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
          AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
          API_URL=http://api:8000
          ENVEOF
          
          # Stop old containers and deploy new ones
          docker-compose down || true
          docker system prune -af --volumes || true
          docker-compose up -d --build
          
          echo "âœ… Deployment successful!"
          EOF
          
          chmod +x deploy.sh
          
          # Execute deployment script on EC2
          scp -i ~/.ssh/deploy_key.pem \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            deploy.sh "$EC2_USER@$EC2_HOST:~/deploy.sh"
          
          ssh -i ~/.ssh/deploy_key.pem \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "$EC2_USER@$EC2_HOST" << 'SSHEOF'
            cd ~
            export REPO_URL="https://github.com/${{ github.repository }}.git"
            export AWS_REGION="${{ secrets.AWS_REGION }}"
            export S3_BUCKET="${{ secrets.S3_BUCKET }}"
            export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
            export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
            bash ~/deploy.sh
          SSHEOF
          
          echo "ðŸŽ‰ Deployment completed!"

      - name: Verify Deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          sleep 10
          curl -f http://$EC2_HOST:8000/health || exit 1
          echo "âœ… API is healthy!"
